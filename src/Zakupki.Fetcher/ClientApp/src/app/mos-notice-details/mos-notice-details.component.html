<div class="notice-details-page">
  <div class="content-container page-container">
    <mat-card>
      <div class="page-header">
        <button mat-button type="button" (click)="goBack()" class="back-button">
          <mat-icon fontIcon="arrow_back"></mat-icon>
          <span>Назад</span>
        </button>

        <div class="page-header-text">
          <div class="notice-number">Закупка {{ details?.purchaseNumber || purchaseNumber }}</div>
          <div class="notice-title">{{ title }}</div>
        </div>

        <div class="header-actions">
          <button mat-stroked-button color="primary" type="button" (click)="loadNotice()" [disabled]="isLoading">
            <mat-icon fontIcon="refresh"></mat-icon>
            <span>Обновить</span>
          </button>
        </div>
      </div>

      <div class="loading-block" *ngIf="isLoading">
        <mat-spinner diameter="48"></mat-spinner>
      </div>

      <div class="error-block" *ngIf="!isLoading && errorMessage">
        <mat-icon fontIcon="error_outline"></mat-icon>
        <p>{{ errorMessage }}</p>
        <button mat-raised-button color="primary" type="button" (click)="loadNotice()">
          Повторить
        </button>
      </div>

      <ng-container *ngIf="!isLoading && !errorMessage">
        <ng-container *ngIf="auctionDetails as auction; else noParsedData">
          <div class="notice-layout">
            <div class="notice-header">
              <div class="notice-header-main">
                <div class="notice-number">
                  <span class="label">Номер извещения</span>
                  <span class="value">{{ details?.purchaseNumber || purchaseNumber }}</span>
                </div>

                <h1 class="notice-title">
                  {{ auction.name || 'Закупка zakupki.mos.ru' }}
                </h1>

                <div class="badge-row">
                  <span class="badge badge-status" *ngIf="auction.state?.name">{{ auction.state?.name }}</span>
                  <span class="badge badge-secondary" *ngIf="auction.offersSigned">Подписание предложений</span>
                  <span class="badge badge-secondary" *ngIf="auction.isElectronicContractExecutionRequired">Электронное исполнение контракта</span>
                </div>
              </div>

              <div class="notice-header-aside">
                <div class="price-block" *ngIf="auction.startCost != null">
                  <div class="label">Начальная (максимальная) цена</div>
                  <div class="price-value">{{ auction.startCost | number: '1.2-2' }}</div>
                </div>

                <div class="etp-block" *ngIf="auction.federalLawName">
                  <div class="label">Закон</div>
                  <div class="etp-name">{{ auction.federalLawName }}</div>
                </div>
              </div>
            </div>

            <div class="section">
              <div class="section-title">Общие сведения</div>
              <table class="info-table">
                <tbody>
                  <tr *ngIf="auction.state?.name">
                    <th>Статус</th>
                    <td>{{ auction.state?.name }}</td>
                  </tr>
                  <tr *ngIf="auction.startDate">
                    <th>Дата начала подачи</th>
                    <td>{{ auction.startDate | date: 'd MMMM yyyy, HH:mm' }}</td>
                  </tr>
                  <tr *ngIf="auction.endDate">
                    <th>Дата окончания подачи</th>
                    <td>{{ auction.endDate | date: 'd MMMM yyyy, HH:mm' }}</td>
                  </tr>
                  <tr *ngIf="auction.initialDuration != null">
                    <th>Продолжительность</th>
                    <td>{{ auction.initialDuration }} ч.</td>
                  </tr>
                  <tr *ngIf="auction.auctionRegion?.length">
                    <th>Регионы закупки</th>
                    <td>
                      <div class="badge-list">
                        <span class="badge badge-neutral" *ngFor="let region of auction.auctionRegion">
                          {{ region.name || region.id || '—' }}
                        </span>
                      </div>
                    </td>
                  </tr>
                  <tr *ngIf="auction.id">
                    <th>Идентификатор закупки</th>
                    <td>{{ auction.id }}</td>
                  </tr>
                  <tr *ngIf="auction.externalId">
                    <th>Внешний идентификатор</th>
                    <td>{{ auction.externalId }}</td>
                  </tr>
                  <tr *ngIf="auction.purchaseTypeId != null">
                    <th>Тип закупки</th>
                    <td>{{ auction.purchaseTypeId }}</td>
                  </tr>
                  <tr *ngIf="auction.organizingTypeId != null">
                    <th>Тип проведения</th>
                    <td>{{ auction.organizingTypeId }}</td>
                  </tr>
                  <tr *ngIf="auction.step != null">
                    <th>Шаг снижения</th>
                    <td>{{ auction.step }}</td>
                  </tr>
                  <tr *ngIf="auction.startCost != null">
                    <th>Начальная цена</th>
                    <td>{{ auction.startCost | number: '1.2-2' }}</td>
                  </tr>
                  <tr *ngIf="auction.nextCost != null">
                    <th>Следующая цена</th>
                    <td>{{ auction.nextCost | number: '1.2-2' }}</td>
                  </tr>
                  <tr *ngIf="auction.lastBetCost != null">
                    <th>Текущая ставка</th>
                    <td>{{ auction.lastBetCost | number: '1.2-2' }}</td>
                  </tr>
                  <tr *ngIf="auction.uniqueSupplierCount != null">
                    <th>Количество участников</th>
                    <td>{{ auction.uniqueSupplierCount }}</td>
                  </tr>
                  <tr *ngIf="auction.federalLawName">
                    <th>Закон</th>
                    <td>{{ auction.federalLawName }}</td>
                  </tr>
                  <tr *ngIf="auction.conclusionReasonName">
                    <th>Основание закупки</th>
                    <td>{{ auction.conclusionReasonName }}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="section" *ngIf="auction.customer as customer">
              <div class="section-title">Заказчик</div>
              <table class="info-table">
                <tbody>
                  <tr *ngIf="customer.name">
                    <th>Наименование</th>
                    <td>{{ customer.name }}</td>
                  </tr>
                  <tr *ngIf="customer.inn">
                    <th>ИНН</th>
                    <td>{{ customer.inn }}</td>
                  </tr>
                  <tr *ngIf="customer.id">
                    <th>Идентификатор</th>
                    <td>{{ customer.id }}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="section" *ngIf="auction.createdByCustomer as owner">
              <div class="section-title">Создатель извещения</div>
              <table class="info-table">
                <tbody>
                  <tr *ngIf="owner.name">
                    <th>Наименование</th>
                    <td>{{ owner.name }}</td>
                  </tr>
                  <tr *ngIf="owner.id">
                    <th>Идентификатор</th>
                    <td>{{ owner.id }}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="section" *ngIf="auction.items?.length">
              <div class="section-title">Позиции закупки</div>
              <table class="items-table">
                <thead>
                  <tr>
                    <th style="width: 40px;">№</th>
                    <th>Наименование</th>
                    <th style="width: 120px;">Количество</th>
                    <th style="width: 140px;">Цена за ед.</th>
                    <th style="width: 90px;">Ед. изм.</th>
                    <th>Код/категория</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of auction.items; let i = index">
                    <td>{{ i + 1 }}</td>
                    <td>
                      <div class="item-name">{{ item.name || 'Без названия' }}</div>
                      <div class="item-meta" *ngIf="item.productionDirectoryName">{{ item.productionDirectoryName }}</div>
                    </td>
                    <td>{{ item.currentValue || item.quantity || '—' }}</td>
                    <td>{{ item.costPerUnit != null ? (item.costPerUnit | number: '1.2-2') : '—' }}</td>
                    <td>{{ item.okeiName || '—' }}</td>
                    <td>
                      <div class="item-meta" *ngIf="item.okpdName">{{ item.okpdName }}</div>
                      <div class="item-meta" *ngIf="item.skuId">SKU: {{ item.skuId }}</div>
                      <div class="item-meta" *ngIf="item.id">ID: {{ item.id }}</div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="section" *ngIf="auction.auctionItem?.length">
              <div class="section-title">Стартовые позиции аукциона</div>
              <table class="items-table">
                <thead>
                  <tr>
                    <th style="width: 40px;">№</th>
                    <th>Наименование</th>
                    <th style="width: 120px;">Количество</th>
                    <th style="width: 140px;">Цена за ед.</th>
                    <th style="width: 90px;">Ед. изм.</th>
                    <th>Код/категория</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of auction.auctionItem; let i = index">
                    <td>{{ i + 1 }}</td>
                    <td>
                      <div class="item-name">{{ item.name || 'Без названия' }}</div>
                      <div class="item-meta" *ngIf="item.productionDirectoryName">{{ item.productionDirectoryName }}</div>
                    </td>
                    <td>{{ item.currentValue || item.quantity || '—' }}</td>
                    <td>{{ item.costPerUnit != null ? (item.costPerUnit | number: '1.2-2') : '—' }}</td>
                    <td>{{ item.okeiName || '—' }}</td>
                    <td>
                      <div class="item-meta" *ngIf="item.okpdName">{{ item.okpdName }}</div>
                      <div class="item-meta" *ngIf="item.skuId">SKU: {{ item.skuId }}</div>
                      <div class="item-meta" *ngIf="item.id">ID: {{ item.id }}</div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="section" *ngIf="auction.deliveries?.length">
              <div class="section-title">Поставки</div>
              <div class="delivery-card" *ngFor="let delivery of auction.deliveries">
                <div class="delivery-header">
                  <div class="delivery-dates" *ngIf="delivery.periodDateFrom || delivery.periodDateTo">
                    <span class="label">Срок поставки</span>
                    <div class="value">
                      {{ delivery.periodDateFrom | date: 'd MMMM yyyy, HH:mm' }}
                      <span *ngIf="delivery.periodDateTo">— {{ delivery.periodDateTo | date: 'd MMMM yyyy, HH:mm' }}</span>
                    </div>
                  </div>
                  <div class="delivery-place" *ngIf="delivery.deliveryPlace">
                    <span class="label">Адрес</span>
                    <div class="value">{{ delivery.deliveryPlace }}</div>
                  </div>
                </div>

                <table class="delivery-items" *ngIf="delivery.items?.length">
                  <thead>
                    <tr>
                      <th style="width: 40px;">№</th>
                      <th>Наименование</th>
                      <th style="width: 120px;">Количество</th>
                      <th style="width: 140px;">Цена за ед.</th>
                      <th style="width: 140px;">Сумма</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let item of delivery.items; let i = index">
                      <td>{{ i + 1 }}</td>
                      <td>{{ item.name || '—' }}</td>
                      <td>{{ item.quantity != null ? item.quantity : '—' }}</td>
                      <td>{{ item.costPerUnit != null ? (item.costPerUnit | number: '1.2-2') : '—' }}</td>
                      <td>{{ item.sum != null ? (item.sum | number: '1.2-2') : '—' }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="section" *ngIf="auction.shortDescription?.data?.length">
              <div class="section-title">Краткое описание документации</div>
              <div class="summary-grid">
                <div class="summary-card" *ngFor="let item of auction.shortDescription?.data">
                  <div class="summary-title">{{ item.title }}</div>
                  <div class="summary-text">{{ item.summary }}</div>
                </div>
              </div>
            </div>

            <div class="section" *ngIf="auction.files?.length">
              <div class="section-title">Документы закупки</div>
              <table class="attachments-table">
                <thead>
                  <tr>
                    <th style="width: 60px;">№</th>
                    <th>Название файла</th>
                    <th style="width: 200px;">Идентификатор</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let file of auction.files; let i = index">
                    <td>{{ i + 1 }}</td>
                    <td>{{ file.name || 'Без названия' }}</td>
                    <td>{{ file.id || '—' }}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="section" *ngIf="formattedJson">
              <div class="section-title">Исходные данные</div>
              <div class="json-block">
                <pre>{{ formattedJson }}</pre>
                <div class="parse-error" *ngIf="parseError">{{ parseError }}</div>
              </div>
            </div>
          </div>
        </ng-container>

        <ng-template #noParsedData>
          <div class="error-block" *ngIf="!formattedJson">
            <mat-icon fontIcon="warning"></mat-icon>
            <p>Нет данных для отображения.</p>
          </div>

          <div class="section" *ngIf="formattedJson">
            <div class="section-title">Исходные данные</div>
            <div class="json-block">
              <pre>{{ formattedJson }}</pre>
              <div class="parse-error" *ngIf="parseError">{{ parseError }}</div>
            </div>
          </div>
        </ng-template>
      </ng-container>
    </mat-card>
  </div>
</div>
