<h2 mat-dialog-title>
  Вложения для {{ data.purchaseNumber }}
</h2>

<mat-dialog-content>
  <p class="dialog-subtitle">{{ data.entryName }}</p>

  <div class="messages">
    <div class="message info" *ngIf="infoMessage">
      <mat-icon fontIcon="info"></mat-icon>
      <span>{{ infoMessage }}</span>
    </div>
    <div class="message error" *ngIf="errorMessage">
      <mat-icon fontIcon="error_outline"></mat-icon>
      <span>{{ errorMessage }}</span>
    </div>
  </div>

  <div class="actions-bar" *ngIf="hasAttachments">
    <button
      mat-raised-button
      color="primary"
      (click)="downloadMissing()"
      [disabled]="isDownloadingAll || !hasMissingAttachments"
    >
      <mat-icon fontIcon="cloud_download"></mat-icon>
      <span>Скачать недостающие</span>
    </button>
    <button
      mat-raised-button
      color="accent"
      (click)="convertAllToMarkdown()"
      [disabled]="isConvertingAll || !hasConvertibleAttachments"
    >
      <mat-icon fontIcon="auto_fix_high"></mat-icon>
      <span>Преобразовать все</span>
    </button>
  </div>

  <div class="table-container" *ngIf="hasAttachments; else noAttachments">
    <div class="loading-overlay" *ngIf="isLoading">
      <mat-spinner diameter="40"></mat-spinner>
    </div>

    <table mat-table [dataSource]="attachments" class="attachments-table">
      <ng-container matColumnDef="fileName">
        <th mat-header-cell *matHeaderCellDef>Файл</th>
        <td mat-cell *matCellDef="let element">
          <div class="file-name">{{ element.fileName }}</div>
          <div class="file-meta" *ngIf="element.description">{{ element.description }}</div>
          <div class="file-meta" *ngIf="element.url">{{ element.url }}</div>
        </td>
      </ng-container>

      <ng-container matColumnDef="documentDate">
        <th mat-header-cell *matHeaderCellDef>Дата документа</th>
        <td mat-cell *matCellDef="let element">
          {{ element.documentDate ? (element.documentDate | date: 'short') : '—' }}
        </td>
      </ng-container>

      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Статус</th>
        <td mat-cell *matCellDef="let element" class="status-cell">
          <mat-icon
            [fontIcon]="element.hasBinaryContent ? 'cloud_done' : 'cloud_off'"
            [ngClass]="{ downloaded: element.hasBinaryContent, missing: !element.hasBinaryContent }"
          ></mat-icon>
          <span>
            {{ element.hasBinaryContent ? 'Загружено' : 'Не загружено' }}
          </span>
          <div class="file-meta" *ngIf="element.fileSize">Размер: {{ element.fileSize | number: '1.0-0' }} байт</div>
          <div class="file-meta">Markdown: {{ element.hasMarkdownContent ? 'готов' : '—' }}</div>
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Действия</th>
        <td mat-cell *matCellDef="let element" class="actions-cell">
          <button
            mat-stroked-button
            color="primary"
            (click)="downloadAttachment(element)"
            [disabled]="downloadingAttachmentId === element.id || !element.hasBinaryContent"
          >
            <mat-icon fontIcon="download"></mat-icon>
            <span>Скачать</span>
          </button>
          <button
            mat-stroked-button
            color="accent"
            (click)="downloadMarkdown(element)"
            [disabled]="downloadingMarkdownAttachmentId === element.id || !element.hasMarkdownContent"
          >
            <mat-icon fontIcon="article"></mat-icon>
            <span>Скачать MD</span>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
  </div>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="close()">Закрыть</button>
</mat-dialog-actions>

<ng-template #noAttachments>
  <div class="no-attachments">
    <mat-icon fontIcon="insert_drive_file"></mat-icon>
    <p>Нет вложений для отображения.</p>
  </div>
</ng-template>
